name: Auto Build OpenClash RunFiles

on:
  schedule:
    - cron: "0 */12 * * *"   # 每 12 小时执行一次
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # -------------------------
      # 1. 检测是否有新版本
      # -------------------------
      - name: Checkout OpenClash (package branch)
        uses: actions/checkout@v4
        with:
          repository: vernesong/OpenClash
          path: OpenClash
          ref: package

      - name: Read latest upstream version
        id: upstream
        run: |
          VERSION=$(head -n 1 OpenClash/master/version)
          echo "UPSTREAM_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Upstream version: $VERSION"

      - name: Get latest release version from this repo
        id: local
        run: |
          LATEST=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          echo "LOCAL_VERSION=$LATEST" >> $GITHUB_ENV
          echo "Local version: $LATEST"

      - name: Compare versions
        run: |
          if [ "${{ env.UPSTREAM_VERSION }}" = "${{ env.LOCAL_VERSION }}" ]; then
            echo "No update. Skip build."
            echo "skip_build=true" >> $GITHUB_ENV
          else
            echo "New version detected!"
          fi

      - name: Stop job if no update
        if: env.skip_build == 'true'
        run: exit 0

      # -------------------------
      # 2. 构建流程（仅在有更新时执行）
      # -------------------------

      - name: Checkout OpenClash (core branch)
        uses: actions/checkout@v4
        with:
          repository: vernesong/OpenClash
          path: Meta
          ref: core

      - name: Prepare build directory
        run: mkdir -p build/x86 build/a53

      - name: Copy IPK files
        run: |
          cp OpenClash/master/*.ipk build/x86/
          cp OpenClash/master/*.ipk build/a53/

      - name: Extract Meta core
        run: |
          tar -xzvf Meta/master/meta/clash-linux-amd64-v1.tar.gz -C build/x86
          tar -xzvf Meta/master/meta/clash-linux-arm64.tar.gz -C build/a53
          mv build/x86/clash build/x86/clash_meta
          mv build/a53/clash build/a53/clash_meta

      - name: Create install.sh
        run: |
          cat << 'EOF' > build/install.sh
          opkg update
          opkg install *.ipk || exit 1
          mv clash_meta /etc/openclash/core/
          sleep 10
          ifconfig br-lan > /dev/null 2>&1
          if [ $? -ne 0 ]; then
              echo "接口错误，重启网络"
              /etc/init.d/network restart
          fi
          EOF
          chmod +x build/install.sh

      - name: Clone makeself
        run: git clone https://github.com/megastep/makeself.git

      - name: Build run files
        run: |
          cp build/install.sh build/x86/
          cp build/install.sh build/a53/
          cd makeself
          ./makeself.sh ../build/x86 openclash-x86-64-${{ env.UPSTREAM_VERSION }}.run "OpenClash Auto Build" ./install.sh
          ./makeself.sh ../build/a53 openclash-aarch64_cortex-a53-${{ env.UPSTREAM_VERSION }}.run "OpenClash Auto Build" ./install.sh

      # -------------------------
      # 3. 发布 Release
      # -------------------------
      - name: Publish Release
        uses: softprops/action-gh-release@v2.1.0
        with:
          tag_name: ${{ env.UPSTREAM_VERSION }}
          files: makeself/*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------
      # 4. 自动清理旧 Release（保留最新 5 个）
      # -------------------------
      - name: Cleanup old releases (keep latest 5)
        run: |
          releases=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases | jq -r '.[].tag_name')

          count=0
          for tag in $releases; do
            count=$((count+1))
            if [ $count -gt 5 ]; then
              echo "Deleting old release: $tag"
              id=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag | jq -r .id)

              curl -X DELETE \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                https://api.github.com/repos/${{ github.repository }}/releases/$id

              curl -X DELETE \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$tag
            fi
          done

      # -------------------------
      # 5. 自动同步到国内镜像（Gitee）
      # -------------------------
      - name: Sync to Gitee Mirror
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/你的用户名/你的仓库.git mirror
          cd mirror

          git remote add github https://github.com/${{ github.repository }}.git
          git pull github main --rebase
          git push origin main --force
